<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/sidebar.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <title>Mad Exam Scheduler</title>
</head>
<body>
<div id="wrapper">

    <!-- Sidebar -->
    <!-- Basic layout taken from https://blackrockdigital.github.io/startbootstrap-simple-sidebar/ under the MIT License
     which can be found at: https://github.com/BlackrockDigital/startbootstrap/blob/gh-pages/LICENSE-->
    <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <h2>Remember to use website to change data to JSON first.</h2>
            <a style="margin-left:10px" href="https://shancarter.github.io/mr-data-converter/">Convert Here!</a>
            <li></li>
            <h2>Reminders: </h2>
            <ol>
                <li>Sections should be under one column</li>
                <li>Class numbers should be used for headers</li>
                <li>Ensure the option selected is Column Dictionary on the parser</li>
            </ol>
        </ul>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Exam scheduling</h1>
                    <p>Paste the formatted data from the conversion website in the box below</p>
                    <textarea id="data-input"></textarea>
                    <button type="button" class="btn btn-primary active" id="submit-data">Process</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /#page-content-wrapper -->

</div>
<script>

    var schedule = [];
    var lengths = {};
    var collisions = {};

    function examSlot() {
        this.classes = [];
        this.examinees = 0;
        this.addExaminees = addExaminees;
        this.updateClasses = updateClasses;
        this.isConflictPresent = isConflictPresent;

    }

    function addExaminees(students) {
        this.examinees += students;
    }

    function updateClasses(classNumber) {
        this.classes.push(classNumber);
    }

    function isConflictPresent(classNumbers) {
        for (var i = 0; i < classNumbers.length; i++) {
            if (this.classes.includes(classNumbers[i]))
                return true;
        }

        return false;

    }


    var t0;
    var t1;

    function sortByConflictNumbers() {
        return Object.keys(collisions).sort(function (a, b) {
            return Object.keys(collisions[a]).length - Object.keys(collisions[b]).length;
        });
    }


    //Parses JSON data and passes on to the conflict detection method
    var jsonParser = function () {
        t0 = performance.now();
        var rawData = $("#data-input").val();

        try {
            var parsedData = $.parseJSON(rawData);
        }
        catch (err) {
            alert("Invalid JSON Data. ");
        }
        conflictDetection(parsedData);
    };

    //Detects conflicts between different classes.
    var conflictDetection = function (jsonObject) {


        for (var key in jsonObject) {
            collisions[key] = {};
            var length = 0;
            for (var number in jsonObject[key]) {
                if (jsonObject[key][number] === '') {
                    continue;
                }
                length++;
                for (var key1 in jsonObject) {
                    if (key1 == key)
                        continue;
                    if (collisions[key][key1])
                        continue;
                    for (var number1 in jsonObject[key1]) {
                        if (jsonObject[key][number] === jsonObject[key1][number1]) {
                            collisions[key][key1] = true;
                        }
                    }
                }
            }
            lengths[key] = length;
        }
        t1 = performance.now();
        scheduler1();
        console.log("call took " + (t1 - t0) + " milliseconds");

    };

    // Schedules exams which are higher priority first
    var scheduler1 = function () {
        var sortedLength = sortByConflictNumbers();
        for (var key in sortedLength) {
            if (key < 200 || (key > 200 && key < 300) || key > 500) {
                if (schedule.length === 0)
                    schedule[0] = new examSlot();

                for (var i = 0; i < schedule.length; i++) {
                    if (schedule[i].isConflictPresent(collisions[key]) || (schedule[i].examinees + lengths[key] > 175)) {
                        if (typeof schedule[i + 1] === 'undefined')
                            schedule.push(new examSlot());
                        continue;
                    }
                    schedule[i].updateClasses(key);
                    schedule[i].addExaminees(lengths[key]);
                }

            }

        }


    };

    var sceduler2 = function (conflicts) {

    };


    $(document).ready(function () {
        $("#wrapper").toggleClass("toggled");
        $("#submit-data").click(jsonParser);
    });


</script>

</body>
</html>